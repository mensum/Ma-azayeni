<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raf TarayÄ±cÄ± ve Kontrol Paneli</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; padding: 15px; text-align: center; }
        #reader { max-width: 450px; margin: auto; border-radius: 15px; border: 5px solid #27ae60; overflow: hidden; }
        #siparis-paneli { display: none; background: white; max-width: 400px; margin: 20px auto; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: left; }
        .label { color: #7f8c8d; font-size: 0.9em; font-weight: bold; }
        .val { font-size: 1.4em; font-weight: bold; color: #2c3e50; margin-bottom: 15px; display: block; }
        .islem { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid #ddd; }
        input[type="number"] { width: 100%; padding: 15px; font-size: 22px; border-radius: 10px; border: 2px solid #27ae60; text-align: center; margin: 10px 0; }
        .btn-gonder { background: #27ae60; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2em; cursor: pointer; }
    </style>
</head>
<body>

<h2 style="color:#2c3e50">ðŸ“¦ Raf SipariÅŸ Sistemi</h2>
<div id="reader"></div>

<div id="siparis-paneli">
    <span class="label">ÃœRÃœN:</span>
    <span id="pMarka" class="val">-</span>
    
    <span class="label">RAF:</span>
    <span id="pRaf" class="val" style="color:orange">-</span>
    
    <span class="label">STOK:</span>
    <span id="pStok" class="val">-</span>

    <div class="islem">
        <label><b>KaÃ§ Adet DÃ¼ÅŸecek?</b></label>
        <input type="number" id="adet" value="1" min="1">
        <button class="btn-gonder" onclick="siparisOnayla()">SÄ°PARÄ°ÅžÄ° TAMAMLA</button>
    </div>
</div>

<script>
let okunanData = null;
const nodeMcuIP = "http://192.168.1.XXX"; // NodeMCU IP'sini buraya gir

function onScanSuccess(decodedText) {
    try {
        let parsed = {};
        // YÄ±ldÄ±zlÄ± formatÄ± parÃ§ala: K:..*M:..*C:..*R:..*S:..
        const parcalar = decodedText.split('*');
        parcalar.forEach(p => {
            const [anahtar, deger] = p.split(':');
            if(anahtar === 'K') parsed.kod = deger;
            if(anahtar === 'M') parsed.marka = deger;
            if(anahtar === 'R') parsed.raf = deger;
            if(anahtar === 'S') parsed.stok = deger;
        });

        if(!parsed.raf) throw new Error("HatalÄ± QR");

        okunanData = parsed;
        document.getElementById("pMarka").innerText = parsed.marka;
        document.getElementById("pRaf").innerText = parsed.raf;
        document.getElementById("pStok").innerText = parsed.stok;

        document.getElementById("siparis-paneli").style.display = "block";
        html5QrCode.stop(); // Okuma baÅŸarÄ±lÄ±ysa kamerayÄ± durdur
    } catch (e) {
        console.log("Tarama devam ediyor...");
    }
}

function siparisOnayla() {
    const adet = document.getElementById("adet").value;
    const raf = okunanData.raf;

    alert("Mekanizma Tetiklendi: Raf " + raf + ", Adet " + adet);

    // NodeMCU'ya istek gÃ¶nder
    fetch(`${nodeMcuIP}/tetikle?raf=${raf}&adet=${adet}`, { mode: 'no-cors' })
    .then(() => {
        alert("ÃœrÃ¼nler baÅŸarÄ±yla bÄ±rakÄ±ldÄ±.");
        location.reload();
    })
    .catch(() => alert("BaÄŸlantÄ± hatasÄ±: NodeMCU bulunamadÄ±!"));
}

const html5QrCode = new Html5Qrcode("reader");
// QRbox boyutunu artÄ±rarak bÃ¼yÃ¼k QR'larÄ± daha iyi odaklamasÄ±nÄ± saÄŸladÄ±k
html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 300 }, onScanSuccess);
</script>
</body>
</html>
