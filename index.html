<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo Otomasyon Pro - V4</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; text-align: center; padding: 15px; color: #333; }
        #reader { max-width: 400px; margin: 20px auto; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: white; }
        #urun-paneli { display: none; background: white; max-width: 400px; margin: 20px auto; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: left; }
        .baslik { font-size: 1.4em; font-weight: bold; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 15px; }
        .detay { margin: 10px 0; font-size: 1.1em; display: flex; justify-content: space-between; }
        .detay b { color: #7f8c8d; }
        .islem-alani { background: #ecf0f1; padding: 15px; border-radius: 10px; margin-top: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        input[type="number"] { width: 100%; padding: 12px; font-size: 18px; border: 2px solid #bdc3c7; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; text-align: center; }
        .btn-onay { background: #27ae60; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; }
        #durum-mesaji { margin-top: 15px; font-weight: bold; border-radius: 5px; padding: 10px; display: none; }
        .basari { background: #d4edda; color: #155724; }
    </style>
</head>
<body>

<h2>ðŸ“¦ Raf Otomasyon Sistemi</h2>
<p>SadeleÅŸtirilmiÅŸ Dev QR KodlarÄ±nÄ± TaratÄ±n</p>

<div id="reader"></div>

<div id="urun-paneli">
    <div class="baslik" id="pMarka">ÃœrÃ¼n AdÄ±</div>
    <div class="detay"><b>ÃœrÃ¼n Kodu:</b> <span id="pKod">-</span></div>
    <div class="detay"><b>Renk:</b> <span id="pRenk">-</span></div>
    <div class="detay"><b>Raf Konumu:</b> <span id="pRaf" style="color:#e67e22; font-weight:bold;">-</span></div>
    <div class="detay"><b>GÃ¼ncel Stok:</b> <span id="pStok">-</span></div>

    <div class="islem-alani">
        <label>KaÃ§ Adet DÃ¼ÅŸÃ¼rÃ¼lecek?</label>
        <input type="number" id="siparisAdet" value="1" min="1">
        <button class="btn-onay" onclick="siparisOnayla()">SÄ°PARÄ°ÅžÄ° TAMAMLA & Ã‡IKART</button>
        <button onclick="location.reload()" style="background:none; border:none; color:gray; cursor:pointer; width:100%; margin-top:10px;">Ä°ptal Et</button>
    </div>
    
    <div id="durum-mesaji"></div>
</div>

<script>
let okunanVeri = null;
const nodeMcuIP = "http://192.168.1.XXX"; // Buraya NodeMCU IP'nizi yazÄ±n

function getLocalStok(kod) {
    let depo = JSON.parse(localStorage.getItem("depo_v4") || "{}");
    return depo[kod];
}

function setLocalStok(kod, veri) {
    let depo = JSON.parse(localStorage.getItem("depo_v4") || "{}");
    depo[kod] = veri;
    localStorage.setItem("depo_v4", JSON.stringify(depo));
}

// YENÄ°: SadeleÅŸtirilmiÅŸ Metni Ã‡Ã¶zen Fonksiyon
function parseSadeQR(text) {
    // Ã–rn: ID:101|R:A1|S:50|M:Elma|C:Kirmizi
    const data = {};
    const parts = text.split('|');
    parts.forEach(part => {
        const [key, value] = part.split(':');
        if(key === 'ID') data.kod = value;
        if(key === 'R')  data.raf = value;
        if(key === 'S')  data.stok = value;
        if(key === 'M')  data.marka = value;
        if(key === 'C')  data.renk = value;
    });
    return data;
}

function onScanSuccess(decodedText) {
    try {
        let data;
        // EÄŸer QR JSON ise (eski sistem)
        if (decodedText.startsWith('{')) {
            data = JSON.parse(decodedText);
        } else {
            // EÄŸer QR Sade Metin ise (Yeni sistem: ID:|R:|S:...)
            data = parseSadeQR(decodedText);
        }

        if(!data.kod) throw new Error("Gecersiz Veri");

        let mevcut = getLocalStok(data.kod);
        if (!mevcut) {
            setLocalStok(data.kod, data);
            mevcut = data;
        }

        okunanVeri = mevcut;
        document.getElementById("pMarka").innerText = okunanVeri.marka || "Bilinmiyor";
        document.getElementById("pKod").innerText = okunanVeri.kod;
        document.getElementById("pRenk").innerText = okunanVeri.renk || "-";
        document.getElementById("pRaf").innerText = okunanVeri.raf;
        document.getElementById("pStok").innerText = okunanVeri.stok;

        document.getElementById("urun-paneli").style.display = "block";
        html5QrCode.stop();

    } catch (e) {
        alert("Hata: QR Kod formatÄ± anlaÅŸÄ±lamadÄ±!");
    }
}

function siparisOnayla() {
    const adet = parseInt(document.getElementById("siparisAdet").value);
    const guncelStok = parseInt(okunanVeri.stok);

    if (adet > guncelStok) {
        alert("Yetersiz Stok!");
        return;
    }

    const mesaj = document.getElementById("durum-mesaji");
    mesaj.style.display = "block";
    mesaj.innerText = "â³ Komut gÃ¶nderiliyor...";

    // NodeMCU'ya komut: /tetikle?raf=A1&adet=3
    fetch(`${nodeMcuIP}/tetikle?raf=${okunanVeri.raf}&adet=${adet}`, { mode: 'no-cors' })
    .then(() => {
        okunanVeri.stok = guncelStok - adet;
        setLocalStok(okunanVeri.kod, okunanVeri);
        
        document.getElementById("pStok").innerText = okunanVeri.stok;
        mesaj.innerText = `âœ… Ä°ÅŸlem Tamam! ${okunanVeri.raf} aktif edildi.`;
        mesaj.className = "basari";
        setTimeout(() => location.reload(), 2500);
    })
    .catch(() => alert("NodeMCU BaÄŸlantÄ± HatasÄ±!"));
}

const html5QrCode = new Html5Qrcode("reader");
html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 280 }, onScanSuccess);
</script>
</body>
</html>
