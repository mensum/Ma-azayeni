<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depo Otomasyon Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; text-align: center; padding: 15px; color: #333; }
        #reader { max-width: 400px; margin: 20px auto; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: white; }
        
        #urun-paneli { 
            display: none; background: white; max-width: 400px; margin: 20px auto; 
            padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: left; 
        }

        .baslik { font-size: 1.4em; font-weight: bold; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 15px; }
        .detay { margin: 10px 0; font-size: 1.1em; display: flex; justify-content: space-between; }
        .detay b { color: #7f8c8d; }

        .islem-alani { background: #ecf0f1; padding: 15px; border-radius: 10px; margin-top: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        
        input[type="number"] { 
            width: 100%; padding: 12px; font-size: 18px; border: 2px solid #bdc3c7; 
            border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; text-align: center;
        }

        .btn-onay { 
            background: #27ae60; color: white; border: none; padding: 15px; 
            width: 100%; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer;
            transition: background 0.3s;
        }
        .btn-onay:hover { background: #219150; }
        .btn-iptal { background: none; border: none; color: #e74c3c; width: 100%; margin-top: 10px; cursor: pointer; }

        #durum-mesaji { margin-top: 15px; font-weight: bold; border-radius: 5px; padding: 10px; display: none; }
        .basari { background: #d4edda; color: #155724; }
    </style>
</head>
<body>

<h2>ðŸ“¦ Raf Otomasyon Sistemi</h2>
<p>ÃœrÃ¼nÃ¼ dÃ¼ÅŸÃ¼rmek iÃ§in QR kodu taratÄ±n</p>

<div id="reader"></div>

<div id="urun-paneli">
    <div class="baslik" id="pMarka">ÃœrÃ¼n AdÄ±</div>
    <div class="detay"><b>ÃœrÃ¼n Kodu:</b> <span id="pKod">-</span></div>
    <div class="detay"><b>Raf Konumu:</b> <span id="pRaf" style="color:#e67e22; font-weight:bold;">-</span></div>
    <div class="detay"><b>GÃ¼ncel Stok:</b> <span id="pStok">-</span></div>

    <div class="islem-alani">
        <label>KaÃ§ Adet DÃ¼ÅŸÃ¼rÃ¼lecek?</label>
        <input type="number" id="siparisAdet" value="1" min="1">
        <button class="btn-onay" onclick="siparisOnayla()">SÄ°PARÄ°ÅžÄ° TAMAMLA & Ã‡IKART</button>
        <button class="btn-iptal" onclick="location.reload()">Ä°ptal Et</button>
    </div>
    
    <div id="durum-mesaji"></div>
</div>

<script>
let okunanVeri = null;
const nodeMcuIP = "http://192.168.1.XXX"; // Buraya NodeMCU IP adresini yazÄ±n

// 1. TarayÄ±cÄ± HafÄ±zasÄ±ndan Stok KontrolÃ¼
function getLocalStok(kod) {
    let depo = JSON.parse(localStorage.getItem("depo_v3") || "{}");
    return depo[kod];
}

function setLocalStok(kod, veri) {
    let depo = JSON.parse(localStorage.getItem("depo_v3") || "{}");
    depo[kod] = veri;
    localStorage.setItem("depo_v3", JSON.stringify(depo));
}

// 2. QR Tarama BaÅŸarÄ±lÄ± OlduÄŸunda
function onScanSuccess(decodedText) {
    try {
        const data = JSON.parse(decodedText);
        let mevcut = getLocalStok(data.kod);

        if (!mevcut) {
            setLocalStok(data.kod, data);
            mevcut = data;
        }

        okunanVeri = mevcut;

        // ArayÃ¼zÃ¼ doldur
        document.getElementById("pMarka").innerText = okunanVeri.marka;
        document.getElementById("pKod").innerText = okunanVeri.kod;
        document.getElementById("pRaf").innerText = okunanVeri.raf;
        document.getElementById("pStok").innerText = okunanVeri.stok;

        // Paneli GÃ¶ster, KamerayÄ± Durdur
        document.getElementById("urun-paneli").style.display = "block";
        html5QrCode.stop();

    } catch (e) {
        alert("Hata: GeÃ§ersiz QR Kod FormatÄ±!");
    }
}

// 3. SipariÅŸi Tamamla ve NodeMCU'yu Tetikle
function siparisOnayla() {
    const adet = parseInt(document.getElementById("siparisAdet").value);
    const guncelStok = parseInt(okunanVeri.stok);

    if (adet > guncelStok) {
        alert("Hata: Stokta yeterli Ã¼rÃ¼n yok!");
        return;
    }

    const mesaj = document.getElementById("durum-mesaji");
    mesaj.style.display = "block";
    mesaj.innerText = "â³ Ä°ÅŸlem yapÄ±lÄ±yor, lÃ¼tfen bekleyin...";
    mesaj.className = "";

    // NodeMCU'ya istek gÃ¶nder: /tetikle?raf=A1&adet=3
    fetch(`${nodeMcuIP}/tetikle?raf=${okunanVeri.raf}&adet=${adet}`, { mode: 'no-cors' })
    .then(() => {
        // Stok dÃ¼ÅŸÃ¼r
        okunanVeri.stok = guncelStok - adet;
        setLocalStok(okunanVeri.kod, okunanVeri);
        
        // ArayÃ¼zÃ¼ GÃ¼ncelle
        document.getElementById("pStok").innerText = okunanVeri.stok;
        mesaj.innerText = `âœ… BaÅŸarÄ±lÄ±! ${okunanVeri.raf} rafÄ±ndan ${adet} adet Ã¼rÃ¼n bÄ±rakÄ±ldÄ±.`;
        mesaj.className = "basari";

        // 3 saniye sonra sayfayÄ± yenile (yeni tarama iÃ§in)
        setTimeout(() => location.reload(), 3000);
    })
    .catch(err => {
        alert("NodeMCU'ya baÄŸlanÄ±lamadÄ±! LÃ¼tfen Wi-Fi baÄŸlantÄ±sÄ±nÄ± kontrol edin.");
    });
}

// KamerayÄ± BaÅŸlat
const html5QrCode = new Html5Qrcode("reader");
html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
</script>

</body>
</html>
