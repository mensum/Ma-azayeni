<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raf Otomasyon TarayÄ±cÄ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; text-align: center; padding: 15px; }
        #reader { max-width: 450px; margin: auto; border-radius: 15px; overflow: hidden; }
        #urun-paneli { display: none; background: white; max-width: 400px; margin: 20px auto; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: left; }
        .baslik { font-size: 1.5em; font-weight: bold; border-bottom: 3px solid #27ae60; padding-bottom: 10px; margin-bottom: 15px; }
        .detay { margin: 8px 0; font-size: 1.2em; display: flex; justify-content: space-between; }
        .btn-onay { background: #27ae60; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1em; }
        #durum-mesaji { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; font-weight: bold; }
        .basari { background: #d4edda; color: #155724; }
    </style>
</head>
<body>

<h2>ðŸ“¦ Raf Kontrol Sistemi</h2>
<div id="reader"></div>

<div id="urun-paneli">
    <div class="baslik" id="pMarka">ÃœrÃ¼n</div>
    <div class="detay"><b>Kod:</b> <span id="pKod">-</span></div>
    <div class="detay"><b>Renk:</b> <span id="pRenk">-</span></div>
    <div class="detay"><b>Raf:</b> <span id="pRaf" style="color:orange">-</span></div>
    <div class="detay"><b>Stok:</b> <span id="pStok">-</span></div>

    <div style="background:#eee; padding:15px; border-radius:10px; margin-top:15px;">
        <label><b>DÃ¼ÅŸÃ¼rÃ¼lecek Adet:</b></label>
        <input type="number" id="siparisAdet" value="1" min="1" style="width:100%; padding:10px; margin:10px 0; font-size:18px;">
        <button class="btn-onay" onclick="siparisOnayla()">SÄ°PARÄ°ÅžÄ° TAMAMLA</button>
    </div>
    <div id="durum-mesaji"></div>
</div>

<script>
let okunanVeri = null;
const nodeMcuIP = "http://192.168.1.XXX"; // Kendi IP'ni buraya yaz!

function getLocalStok(kod) {
    let depo = JSON.parse(localStorage.getItem("depo_final") || "{}");
    return depo[kod];
}

function setLocalStok(kod, veri) {
    let depo = JSON.parse(localStorage.getItem("depo_final") || "{}");
    depo[kod] = veri;
    localStorage.setItem("depo_final", JSON.stringify(depo));
}

function onScanSuccess(decodedText) {
    try {
        let data = {};
        // YÄ±ldÄ±zlÄ± formatÄ± ayÄ±kla
        if (decodedText.includes('*')) {
            decodedText.split('*').forEach(p => {
                const [k, v] = p.split(':');
                if(k === 'KOD')   data.kod = v;
                if(k === 'MARKA') data.marka = v;
                if(k === 'RENK')  data.renk = v;
                if(k === 'RAF')   data.raf = v;
                if(k === 'STOK')  data.stok = v;
            });
        } else {
            data = JSON.parse(decodedText);
        }

        let mevcut = getLocalStok(data.kod) || data;
        okunanVeri = mevcut;

        document.getElementById("pMarka").innerText = okunanVeri.marka;
        document.getElementById("pKod").innerText = okunanVeri.kod;
        document.getElementById("pRenk").innerText = okunanVeri.renk;
        document.getElementById("pRaf").innerText = okunanVeri.raf;
        document.getElementById("pStok").innerText = okunanVeri.stok;

        document.getElementById("urun-paneli").style.display = "block";
        html5QrCode.stop();
    } catch (e) {
        alert("QR Okuma HatasÄ±! LÃ¼tfen yeni etiket oluÅŸturucuyu kullanÄ±n.");
    }
}

function siparisOnayla() {
    const adet = parseInt(document.getElementById("siparisAdet").value);
    const guncelStok = parseInt(okunanVeri.stok);

    if (adet > guncelStok) { alert("Yetersiz Stok!"); return; }

    const msg = document.getElementById("durum-mesaji");
    msg.style.display = "block";
    msg.innerText = "â³ Mekanizma Ã§alÄ±ÅŸÄ±yor...";

    fetch(`${nodeMcuIP}/tetikle?raf=${okunanVeri.raf}&adet=${adet}`, { mode: 'no-cors' })
    .then(() => {
        okunanVeri.stok = guncelStok - adet;
        setLocalStok(okunanVeri.kod, okunanVeri);
        document.getElementById("pStok").innerText = okunanVeri.stok;
        msg.innerText = `âœ… BaÅŸarÄ±lÄ±! ${okunanVeri.raf} aktif.`;
        msg.className = "basari";
        setTimeout(() => location.reload(), 2000);
    })
    .catch(() => alert("NodeMCU BaÄŸlantÄ± HatasÄ±!"));
}

const html5QrCode = new Html5Qrcode("reader");
html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 280 }, onScanSuccess);
</script>
</body>
</html>
